- name: Deploy SSH Keys
  hosts: webservers
  become: true

  tasks:

  - name: Load CSV file with users
    ansible.builtin.include_tasks: tasks/load_csv.yml

  - name: Remove users
    ansible.builtin.user:
      name: "{{ item.User }}"
      state: absent
      remove: yes
    loop: "{{ all_users.list }}"

  - name: Remove user keys from local folder
    ansible.builtin.file:
      path: ./files/usr_keys
      state: absent
    delegate_to: localhost
    become: false
    run_once: true

  - name: Detect ssh demon
    ansible.builtin.set_fact:
      ssh_demon_name: "{{ 'ssh' if ansible_facts['distribution'] in ['Debian', 'Linux Mint'] else 'sshd' }}"

  - name: Password login allowed
    ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PasswordAuthentication'
      line: 'PasswordAuthentication yes'
      state: present
      backup: yes
    notify: Restart sshd

  - name: Enable challenge login
    ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^ChallengeResponseAuthentication'
      line: 'ChallengeResponseAuthentication yes'
      state: present
    notify: Restart sshd

  - name: Enable public key login
    ansible.builtin.lineinfile:
      path: /etc/ssh/sshd_config
      regexp: '^PubkeyAuthentication'
      line: 'PubkeyAuthentication yes'
      state: present
    notify: Restart sshd

  handlers:
    - name: Restart sshd
      ansible.builtin.service:
        name: "{{ ssh_demon_name }}"
        state: restarted

