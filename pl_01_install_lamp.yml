---

- name: Install LAMP stack
  hosts: webservers
  become: true

  tasks:

    - name: Set hostname if hostname is localhost
      ansible.builtin.include_tasks: tasks/set_hostname.yml
      when: ansible_hostname  == "localhost"

    - name: Install LAMP on Debian
      ansible.builtin.include_tasks: tasks/lamp_debian.yml
      when: ansible_os_family == "Debian"

    - name: Install LAMP on RHEL
      ansible.builtin.include_tasks: tasks/lamp_rhel.yml
      when: ansible_os_family == "RedHat"

    - name: Install LAMP on others
      ansible.builtin.include_tasks: tasks/lamp_general.yml
      when: ansible_os_family not in ['RedHat', 'Debian']

    - name: Create index page
      ansible.builtin.copy:
        dest: /var/www/html/index.php
        content: |
          <html>
          <head><title> LAMP stack in ON </title></head>
          <body><h1>Hello from "{{ ansible_hostname }}" page!</h1></body>
          </html>
        mode: '0644'

    - name: Remove default index file to not prioritize over index.php
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/www/html/index.html
        - /var/www/html/index.htm

    - name: Create rollback folder
      delegate_to: localhost
      become: false
      run_once: false  # In case of more hostnames can be set to true to make playbook more swift
      ansible.builtin.file:
        path: files/rollback_files
        state: directory
        mode: '0755'

    - name: Make backup for /etc/firewalld_conf
      ansible.builtin.fetch:
        src: /etc/firewalld/firewalld.conf
        dest: files/rollback_files/etc_firewalld_conf_{{ inventory_hostname }}.bkp
        flat: yes
    
    - name: Allow port 80 for http
      ansible.posix.firewalld:
        service: http
        permanent: true
        state: enabled
        immediate: true

    - name: Allow port 443 for https
      ansible.posix.firewalld:
        service: https
        permanent: true
        state: enabled
        immediate: true
